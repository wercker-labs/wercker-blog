---
title: Import Go package from private git repository
date: 2013-09-18
tags: deployment, golang
author: Pieter Joost van de Sande
gravatarhash: 5864d682bb0da7bedf31601e4e3172e7
published: false
---

An import path in Go denotes a package stored in the local file system. Certain import paths also describe how to obtain the source code for the package, like: `github.com/user/project`. This denotes that the source code is hosted at github.com. A repository can be private, and this means that you need a way to gain access to it. In this post I want to describe how to leverage deployment keys for this to gain access to private packages hosted in an other repository.

## Deploy Keys

A deploy key is simply a password-less SSH key that ideally doesn't belong to any developer, but is configured to have readonly access to a repostory. Both Github and BitBucket support deploy keys and they do not use up one of the plan limit users. The keys are not generated on Github or BitBucket, they only allow you to add the public part of a key. The key itself can be generated by wercker.

## Adding a key to your application

Wercker allows you to generate SSH key for your application, which we can be used as a deploy key. Open your application at wercker and go to the application settings tab. Here you find the _key management_ section. Use the generate new key pair button to generate a new key.

![create ssh key at wercker](/images/posts/import-go-package-from-private-git-repository/generate-key.png)

## Add variable for key

Before we can use the key in our build pipeline, we need expose it as a variable. This can be done in the pipeline section of the application settings tab. Press the add new variable button, pick the SSH Key pair option and select your key.

![](/images/posts/import-go-package-from-private-git-repository/pipeline-variable.png)

This will expose the key as two variables, in my case: `MYPACKAGE_KEY_PUBLIC` and `MYPACKAGE_KEY_PRIVATE`. The first one holds the public part of the key and the later the private part.

## Add key as deploy key

You can copy the public key from the previous step and add this as a deploy key to the private git repository that contains the package. This option can be found in the settings page of your repository at Github or BitBucket.

![deploy key](/images/posts/import-go-package-from-private-git-repository/deploy-key.png)

## Write key in build pipeline

QUICK HACK:

``` yaml
box: wercker/golang
build:
  steps:
    - script:
        name: Enable verbose git ssh logging
        code: |-
          echo 'ssh -v $@' > $HOME/git_ssh
          chmod +x $HOME/git_ssh
          export GIT_SSH="$HOME/git_ssh"

    - script:
        name: Setup deploy key
        code: |-
          mkdir -p "$HOME/.ssh"
          cd "$HOME/.ssh"

          echo -e "$MYPACKAGE_KEY_PRIVATE" > id_rsa_mypackage
          chmod 0700 id_rsa_mypackage

          #sed -i -e "1i IdentityFile $HOME/.ssh/id_rsa_mypackage" config
          echo "IdentityFile $HOME/.ssh/id_rsa_mypackage" > config
          chmod 0600 config

    - script:
        name: Echo .ssh/config
        code: |-
          echo '$HOME/.ssh/id_rsa_mypackage'
          cat "$HOME/.ssh/id_rsa_mypackage"

          echo '$HOME/.ssh/config'
          cat "$HOME/.ssh/config"

    - pjvds/setup-go-workspace

    - script:
        name: Clone private packages
        code: |-
          mkdir -p $GOPATH/src/github.com/pjvds/

          cd $GOPATH/src/github.com/pjvds/
          git clone git@github.com:pjvds/private-package.git

    # - script:
    #     name: Populate cache
    #     code: |-
    #         # BEFORE YOU COPY AND USE THIS STEP IN YOUR OWN BUILD PIPELINE
    #         # MAKE SURE YOU SET $WERCKER_SOURCE_DIR TO THE PACKAGE DIRECTORY
    #         # OR YOUR PROJECT, LIKE: $GOPATH/github.com/pjvds/httpcallback.io
    #         if test -d "$WERCKER_CACHE_DIR/go-pkg-cache"; then rsync -avzv --exclude "$WERCKER_SOURCE_DIR" "$WERCKER_CACHE_DIR/go-pkg-cache/" "$GOPATH/" ; fi

    - script:
        name: Get dependencies
        code: |-
            go get -v ./...

    - script:
        name: Build
        code: |
            go build -a -v ./...

    - script:
        name: Test
        code: |-
            go test ./...

    - script:
        name: Store cache
        code: |-
            # BEFORE YOU COPY AND USE THIS STEP IN YOUR OWN BUILD PIPELINE
            # MAKE SURE YOU SET $WERCKER_SOURCE_DIR TO THE PACKAGE DIRECTORY
            # OR YOUR PROJECT, LIKE: $GOPATH/github.com/pjvds/httpcallback.io
            rsync -avzv --exclude "$WERCKER_SOURCE_DIR" "$GOPATH/" "$WERCKER_CACHE_DIR/go-pkg-cache/"

    - script:
        name: Copy output
        code: |-
          rsync -avz "$WERCKER_SOURCE_DIR/" "$WERCKER_OUTPUT_DIR"
```
